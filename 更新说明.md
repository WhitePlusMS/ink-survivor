# 更新说明文档

## 2026-02-20

### 问题描述
大纲生成接口报错：`TypeError: Cannot read properties of undefined (reading 'map')`（实际错误是 `reading 'length'`）

### 错误分析
错误发生在 `OutlineService.saveOutline` 方法中，当 LLM 返回的 JSON 缺少 `chapters` 字段或字段为 undefined 时，尝试访问 `outline.chapters.length` 会导致报错。

根本原因：测试 API 使用了 `outlineService.generateOutline`，它调用的是 `streamChat` 方法，而正常业务流程使用的是 `outlineGenerationService.generateOutline`，它调用的是 `testModeSendChat` 方法。两者调用的 LLM 接口不同。

### 修复内容

#### 1. 大纲生成测试 - 与正常业务流程一致
- 修改 `/api/books/[id]/generate-outline` API 使用 `outlineGenerationService.generateOutline`
- 删除了测试页面中的"故事创意"输入框（正常业务流程不需要）

#### 2. 大纲优化测试 - 新建 API
- 创建新 API `/api/books/[id]/optimize-outline`，调用 `outlineGenerationService.generateNextChapterOutline`
- 修改测试页面调用新 API
- 删除测试页面中的"读者反馈"输入框（该参数在正常业务流程中不需要）

#### 3. 参赛决策测试 - 新建 API
- 创建新 API `/api/admin/test/join-decision`，测试单个 Agent 的参赛决策
- 修改测试页面调用新 API
- 删除测试页面中的"赛季主题"输入框（API 会自动获取当前赛季）

#### 4. 赛季配置优化测试
- 已有对应的 API `/api/admin/season-queue/[id]/optimize`，无需修改

#### 5. 读者评论测试
- 使用测试专用 API `/api/admin/test/generate-reader-comment`，这是正常的，因为正常业务流程中读者评论是由系统自动生成的

#### 6. 防御性检查和调试日志
- 在 `saveOutline` 方法中添加了对 `outline`、`outline.chapters`、`outline.characters` 的防御性检查
- 在解析 JSON 后，输出完整的 outline 数据用于调试
- 在解析失败时，输出原始 LLM 响应内容

### 修改文件
- `src/services/outline.service.ts` - 防御性检查和调试日志
- `src/app/api/books/[id]/generate-outline/route.ts` - 与正常业务流程保持一致
- `src/app/api/books/[id]/optimize-outline/route.ts` - 新建大纲优化 API
- `src/app/api/admin/test/join-decision/route.ts` - 新建参赛决策 API
- `src/app/admin/test/outline/page.tsx` - 删除故事创意输入框
- `src/app/admin/test/outline-optimize/page.tsx` - 使用新 API
- `src/app/admin/test/join-decision/page.tsx` - 使用新 API
