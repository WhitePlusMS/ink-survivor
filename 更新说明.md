# 更新说明文档

## 2026-02-20

### 修改内容

#### AI 读者评论优化 - 增加评价侧重点选择

**问题描述**：当前 AI 读者评论风格单一，所有读者都用同样的评价维度，导致评论内容重复度高、缺乏多样性。

**解决方案**：在读者配置中增加「评价侧重点」选择器，让用户可以选择自己更关注的评价维度，从而生成不同风格的评论。

**修改文件**：

1. **src/services/user.service.ts**
   - 在 `ReaderConfig` 接口的 `readingPreferences` 中添加 `commentFocus?: string[]` 字段
   - 用于存储用户选择的评价侧重点：剧情、人物、文笔、设定、综合

2. **src/components/profile/agent-config-form.tsx**
   - 在读者配置表单的「阅读偏好」区块中添加「评价侧重点」选择器
   - 新增 `COMMENT_FOCUS_OPTIONS` 常量，包含 5 个选项：
     - 剧情：关注情节推进、节奏、悬念
     - 人物：关注角色塑造、成长、互动
     - 文笔：关注语言表达、描写、氛围
     - 设定：关注世界观、力量体系、逻辑
     - 综合：全面评价（默认）
   - 默认值为「综合」，用户可多选

3. **src/lib/secondme/prompts.ts**
   - 修改 `buildReaderActionControl()` 函数，接收 `commentFocus` 参数
   - 根据不同的侧重点生成不同的评价维度提示：
     - 剧情：剧情推进节奏、悬念设计、情节反转、伏笔铺设
     - 人物：角色塑造、人物成长、人物互动、人物动机
     - 文笔：语言表达、描写手法、氛围营造、叙事风格
     - 设定：世界观构建、力量体系、逻辑自洽、创新程度
     - 综合：剧情节奏、角色塑造、文笔风格、创新程度

4. **src/services/reader-agent.service.ts**
   - 修改调用 `buildReaderActionControl()` 时传入 `readerConfig.readingPreferences.commentFocus` 参数

**效果示例**：

| 用户选择的侧重点 | AI 评论侧重点 |
|----------------|--------------|
| 剧情 | "剧情推进太慢，第一章光铺垫就用了800字，节奏缺乏张力。" |
| 人物 | "主角性格比较单薄，动机不够清晰，配角更是工具人属性明显。" |
| 文笔 | "场景描写比较空洞，缺乏画面感，氛围营造不够到位。" |
| 设定 | "世界观设定有很多漏洞，力量体系前后不一致，逻辑不够自洽。" |

---

## 2026-02-20

### 修改内容

#### 读者评论测试 - 生成评论后自动存入数据库
- 修改 `src/app/api/admin/test/generate-reader-comment/route.ts`
- 在生成评论后，自动将评论存入数据库的 Comment 表
- 存储字段：
  - `bookId` - 书籍ID
  - `chapterId` - 章节ID
  - `isHuman` - false（AI生成的评论）
  - `aiRole` - '读者'
  - `rating` - 评分（1-10）
  - `praise` - 赞扬内容
  - `critique` - 批评内容
- 返回值增加 `commentId`，便于调试确认存储成功
- 添加日志输出确认评论已存入数据库

---

## 2026-02-20

### 问题描述
大纲生成接口报错：`TypeError: Cannot read properties of undefined (reading 'map')`（实际错误是 `reading 'length'`）

### 错误分析
错误发生在 `OutlineService.saveOutline` 方法中，当 LLM 返回的 JSON 缺少 `chapters` 字段或字段为 undefined 时，尝试访问 `outline.chapters.length` 会导致报错。

根本原因：测试 API 使用了 `outlineService.generateOutline`，它调用的是 `streamChat` 方法，而正常业务流程使用的是 `outlineGenerationService.generateOutline`，它调用的是 `testModeSendChat` 方法。两者调用的 LLM 接口不同。

### 修复内容

#### 1. 大纲生成测试 - 与正常业务流程一致
- 修改 `/api/books/[id]/generate-outline` API 使用 `outlineGenerationService.generateOutline`
- 删除了测试页面中的"故事创意"输入框（正常业务流程不需要）

#### 2. 大纲优化测试 - 新建 API
- 创建新 API `/api/books/[id]/optimize-outline`，调用 `outlineGenerationService.generateNextChapterOutline`
- 修改测试页面调用新 API
- 删除测试页面中的"读者反馈"输入框（该参数在正常业务流程中不需要）

#### 3. 参赛决策测试 - 新建 API
- 创建新 API `/api/admin/test/join-decision`，测试单个 Agent 的参赛决策
- 修改测试页面调用新 API
- 删除测试页面中的"赛季主题"输入框（API 会自动获取当前赛季）

#### 4. 赛季配置优化测试
- 已有对应的 API `/api/admin/season-queue/[id]/optimize`，无需修改

#### 5. 读者评论测试
- 使用测试专用 API `/api/admin/test/generate-reader-comment`，这是正常的，因为正常业务流程中读者评论是由系统自动生成的

#### 6. 防御性检查和调试日志
- 在 `saveOutline` 方法中添加了对 `outline`、`outline.chapters`、`outline.characters` 的防御性检查
- 在解析 JSON 后，输出完整的 outline 数据用于调试
- 在解析失败时，输出原始 LLM 响应内容

### 修改文件
- `src/services/outline.service.ts` - 防御性检查和调试日志
- `src/app/api/books/[id]/generate-outline/route.ts` - 与正常业务流程保持一致
- `src/app/api/books/[id]/optimize-outline/route.ts` - 新建大纲优化 API
- `src/app/api/admin/test/join-decision/route.ts` - 新建参赛决策 API
- `src/app/admin/test/outline/page.tsx` - 删除故事创意输入框
- `src/app/admin/test/outline-optimize/page.tsx` - 使用新 API
- `src/app/admin/test/join-decision/page.tsx` - 使用新 API
