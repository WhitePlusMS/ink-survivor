# InkSurvivor 项目 - 任务开发指南

## 项目概述
基于 **Next.js 14 + SQLite + Prisma** 的赛季制 AI 创作平台

---

## 三窗口并行开发方案

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  窗口 1 (后端)         │  窗口 2 (后端)         │  窗口 3 (前端)          │
├─────────────────────────────────┼─────────────────────────┼───────────────────────┤
│  01 → 02 → 04 → 05 → 21       │  06 → 07 → 08 → 22    │  01 → 03 → 23         │
│                                 │  09 → 10 → 11          │  12 → 13 → 14        │
│                                 │                        │  15 → 16 → 17        │
│                                 │                        │  18 → 19 → 20        │
└─────────────────────────────────┴─────────────────────────┴───────────────────────┘

═══════════════════════════════════════════════════════════════════════════════════════
                                    时间轴
═══════════════════════════════════════════════════════════════════════════════════════

第1阶段 (必须串行)           第2阶段 (可并行)               第3阶段 (可并行)
┌──────────────────┐      ┌────────────────────────────┐  ┌────────────────────────────┐
│ 窗口1: 01 → 02   │      │ 窗口1: 04 → 05 → 21       │  │ 窗口1: (可等待或做扩展)    │
│ 窗口2: (等待 02)  │ ───► │ 窗口2: 06 → 07 → 08 → 22 │ ─►│ 窗口2: 09 → 10 → 11       │
│ 窗口3: (等待 01)  │      │ 窗口3: 01 → 03 → 23       │  │ 窗口3: 12 → 13 → 14       │
└──────────────────┘      └────────────────────────────┘  │ 15 → 16 → 17 → 18       │
                                                           │ 19 → 20                  │
═══════════════════════════════════════════════════════════════════════════════════════
```

---

## 执行顺序详解

### ⏱️ 第 1 阶段：基础设施（必须串行，窗口 1 优先）

> **窗口 1** 先执行，窗口 2 和 3 等待

| 顺序 | 任务 | 说明 | 依赖 | 产出文件 |
|:----:|------|------|:----:|----------|
| 1 | **01-project-initialization** | 项目初始化 | 无 | package.json, 环境变量, prisma.ts |
| 2 | **02-database-schema** | 数据库 Schema | 01 | prisma/schema.prisma |
| └► 窗口 2、3 可以开始了 ─────────────────────────────────────────────── |

### ⏱️ 第 2 阶段：核心开发（可三窗口并行）

> **三个窗口可以同时开始**，但窗口 2 需等待窗口 1 完成 02

#### 窗口 1：认证与 API 客户端
| 顺序 | 任务 | 说明 | 依赖 | 产出 |
|:----:|------|------|:----:|------|
| 3 | **04-secondme-oauth.md** | OAuth2 认证 | 01, 02 | /api/auth/* |
| 4 | **05-secondme-api-client.md** | SecondMe API 封装 | 04 | lib/secondme/* |
| 5 | **21-user-service.md** | 用户服务 | 02 | services/user.ts |

#### 窗口 2：业务逻辑（必须等窗口 1 完成 02）
| 顺序 | 任务 | 说明 | 依赖 | 产出 |
|:----:|------|------|:----:|------|
| 3 | **06-season-crud.md** | 赛季 CRUD | 02 | /api/seasons/* |
| 4 | **07-book-crud-outline.md** | 书籍 + 大纲 | 02, 05 | /api/books/* |
| 5 | **08-chapter-generation.md** | 章节生成 | 05, 07 | /api/stream/chapter/* |
| 6 | **22-websocket.md** | WebSocket | 08 | ws-manager.ts |
| 7 | **09-comments-interactions.md** | 评论互动 | 02, 07 | /api/comments/* |
| 8 | **10-economy-system.md** | 经济系统 | 07, 09 | services/economy.ts |
| 9 | **11-scoring-leaderboard.md** | 排行榜 | 02, 07, 09 | /api/leaderboard/* |

#### 窗口 3：前端组件（可独立开始）
| 顺序 | 任务 | 说明 | 依赖 | 产出 |
|:----:|------|------|:----:|------|
| 3 | **03-ui-components.md** | UI 组件库 | 01 | components/ui/* |
| 4 | **23-tailwind-config.md** | Tailwind 配置 | 01 | tailwind.config.ts |

### ⏱️ 第 3 阶段：页面开发（可三窗口并行）

> 窗口 1 可以继续做扩展功能或等待；窗口 2、3 可以并行

#### 窗口 1：继续后端完善
| 顺序 | 任务 | 说明 |
|:----:|------|------|
| 10 | 等待窗口 2 完成基础 API，或开发扩展功能 |

#### 窗口 2：完成后端收尾
| 顺序 | 任务 | 说明 |
|:----:|------|------|
| 10 | 继续完成 10-economy-system.md |
| 11 | 继续完成 11-scoring-leaderboard.md |

#### 窗口 3：前端页面（依赖组件完成）
| 顺序 | 任务 | 说明 | 依赖 |
|:----:|------|------|:----:|
| 5 | **12-frontend-home.md** | 首页/书架 | 03, 06, 07 |
| 6 | **13-frontend-reader.md** | 阅读器 | 03, 08, 09 |
| 7 | **14-frontend-profile.md** | 个人中心 | 03, 04 |
| 8 | **15-frontend-create.md** | 创建页面 | 03, 06, 07 |
| 9 | **16-frontend-favorites.md** | 收藏页面 | 03, 07, 09 |
| 10 | **17-comments-component.md** | 评论组件 | 03, 09 |
| 11 | **18-agent-config-edit.md** | Agent 配置 | 03 |
| 12 | **19-season-detail-page.md** | 赛季详情 | 06, 11 |
| 13 | **20-outline-display.md** | 大纲展示 | 03 |

---

## 三窗口任务分配速查表

```
┌────────────────────────────────────────────────────────────────────────────────┐
│                           窗口 1 (后端 - 先启动)                                │
├────────────────────────────────────────────────────────────────────────────────┤
│ 01 → 02 → 04 → 05 → 21 → [可休息或做扩展]                                   │
└────────────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────────┐
│                           窗口 2 (后端 - 等 02 后启动)                        │
├────────────────────────────────────────────────────────────────────────────────┤
│ 等待 02 完成                                                                 │
│ ↓                                                                         │
│ 06 → 07 → 08 → 22 → 09 → 10 → 11                                         │
└────────────────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────────────────┐
│                           窗口 3 (前端 - 等 01 后启动)                        │
├────────────────────────────────────────────────────────────────────────────────┤
│ 01 完成后                                                                    │
│ ↓                                                                         │
│ 03 → 23 → 12 → 13 → 14 → 15 → 16 → 17 → 18 → 19 → 20                  │
└────────────────────────────────────────────────────────────────────────────────┘
```

---

## 冲突文件管理（非常重要）

以下文件**只能由指定任务创建/修改**，多人协作时禁止同时修改：

| 文件 | 只能由任务 | 其他任务如何处理 |
|------|----------|----------------|
| `prisma/schema.prisma` | **01 → 02** | 其他任务只能读取引用 |
| `tailwind.config.ts` | **01 → 23** | 其他任务只能使用配置 |
| `src/app/globals.css` | **01** | 其他任务只能引用 |
| `src/lib/prisma.ts` | **01** | 其他任务只能 import |

---

## 依赖关系图

```
无依赖
  │
  ├─► 01-project-initialization ──────────────────────────────────────┐
  │                                                                  │
  │   01完成后                                                      │
  │    │                                                           │
  │    ├──► 02-database-schema ──────────────────────────────────┐   │
  │    │                                                          │   │
  │    │   02完成后                                               │   │
  │    │    │                                                    │   │
  │    │    ├──► 04-secondme-oauth ─────────────────────────┐   │   │
  │    │    │                                                    │   │
  │    │    ├──► 21-user-service ──────────────────────────┐   │   │
  │    │    │                                                    │   │
  │    │    └──► 03-ui-components ─────────────────────────┐   │   │
  │    │                                                         │   │
  │    └──► 23-tailwind-config ────────────────────────────┐   │   │
  │                                                              │   │
  └──────────────────────────────────────────────────────────────┘   │
                                                                   │
  04完成后                                                      │
   │                                                             │
   ├──► 05-secondme-api-client ───────────────────────────────┐  │
   │                                                           │  │
   02完成后                                                    │  │
   │                                                           │  │
   ├──► 06-season-crud ────────────────────────────────────┐ │  │
   │                                                         │ │  │
   ├──► 07-book-crud-outline ──────────────────┐            │ │  │
   │                                             │            │ │  │
   │  05完成后                                │            │ │  │
   │   │                                     │            │ │  │
   │   ├──► 08-chapter-generation ──────────┐ │            │ │  │
   │   │                                     │ │            │ │  │
   │   └──► 22-websocket ←──────────────────┘ │            │ │  │
   │                                           │            │ │  │
   └──► 09-comments-interactions ───────────────────────────┘ │  │
                                                               │  │
   07完成后                                                    │  │
   │                                                           │  │
   ├──► 10-economy-system ←───────────────────────────────┐  │  │
   │                                                         │  │  │
   └──► 11-scoring-leaderboard ←───────────────────────────┘  │  │
                                                                │
   03完成后                                                    │
   │                                                           │
   ├──► 12-frontend-home ←─────────────┐                     │
   │                                   │                     │
   ├──► 13-frontend-reader ←───────────┼──► 依赖多个 API    │
   │                                   │                     │
   ├──► 14-frontend-profile ──────────┤                     │
   │                                   │                     │
   ├──► 15-frontend-create ──────────┤                     │
   │                                   │                     │
   ├──► 16-frontend-favorites ───────┤                     │
   │                                   │                     │
   ├──► 17-comments-component ───────┤                     │
   │                                   │                     │
   ├──► 18-agent-config-edit ────────┤                     │
   │                                   │                     │
   ├──► 19-season-detail-page ←───────┴──► 依赖 06, 11     │
   │                                                         │
   └──► 20-outline-display ────────────────────────────────┘
```

---

## 最小可行 MVP 任务顺序（单窗口快速开发）

如果你只有一个窗口，按以下顺序最省时：

1. **01** → 02（基础设施）
2. **03** → 23（前端组件）
3. **04** → 05（认证）
4. **06** → 07（赛季+书籍）
5. **08**（章节生成）
6. **12** → 13（首页+阅读器）
7. **09** → 17（评论）
8. **14** → 15（个人中心+创建）

---

## 验收检查清单

### 后端检查
- [ ] `npx prisma generate` 成功
- [ ] `npx prisma db push` 成功
- [ ] `npm run build` 成功
- [ ] 所有 API 返回格式一致

### 前端检查
- [ ] 页面可正常访问
- [ ] 组件样式统一
- [ ] API 调用正常

### 联调检查
- [ ] 前后端接口对接成功
- [ ] 全流程测试通过
