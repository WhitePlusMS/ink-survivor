# 更新日志

## v3.3 - 修复赛季删除外键约束问题

### 修改日期
2026-02-16

### Bug 修复

#### 1. 修复删除赛季时报外键约束错误
- **问题描述**:
  - 删除赛季时报错 `Foreign key constraint violated: Like_chapterId_fkey (index)` 和 `Foreign key constraint violated: Comment_bookId_fkey (index)`
  - 原因：删除顺序不正确，导致外键约束失败

- **修改文件**:
  - `src/services/season.service.ts`: 修正 `deleteSeason` 方法的删除顺序

- **解决方案**:
  - 删除顺序：reading → like → comment → chapter → book → season
  - 在删除章节前，先删除所有评论（包括书籍评论和章节评论）
  - 在删除章节前，先删除章节点赞记录

---

## v3.2 - 历史赛季前十名书籍展示

### 修改日期
2026-02-16

### 功能优化

#### 1. 历史赛季显示前十名书籍
- **修改文件**:
  - `src/types/score.ts`: 扩展 `LeaderboardEntry` 类型，添加 BookCard 需要的额外字段
  - `src/services/leaderboard.service.ts`: 修改 `generateLeaderboard` 方法，返回书籍封面、简介、浏览量、评论数等字段
  - `src/app/admin/admin-season-client.tsx`:
    - 添加导入 BookCard 组件和 Trophy 图标
    - 添加排行榜数据状态 `leaderboardData`
    - 添加获取赛季排行榜函数 `fetchSeasonLeaderboard`
    - 添加 useEffect 在切换到历史赛季 tab 时自动加载所有已结束赛季的排行榜
    - 在每个已结束的历史赛季详情下默认显示热度 TOP 10 书籍卡片

- **功能说明**:
  - 打开历史赛季界面时，自动加载所有已结束赛季的前十名书籍
  - 按热度(heat)排序显示
  - 书籍卡片使用主页相同的 BookCard 组件，样式统一
  - 卡片显示排名、封面、标题、作者、简介、章节数、热度、评论数等信息
  - 非管理员和管理员都能看到

#### 2. 赛季删除后自动刷新
- **修改文件**:
  - `src/app/admin/admin-season-client.tsx`: 修改 `handleDeleteSeason` 函数，删除后清除该赛季的排行榜缓存数据并刷新页面

- **功能说明**:
  - 非管理员和管理员都能在历史赛季详情中看到"查看前十名"按钮
  - 点击按钮后展开显示该赛季得分前10名的书籍卡片
  - 书籍卡片使用主页相同的 BookCard 组件，样式统一
  - 卡片显示排名、封面、标题、作者、简介、章节数、热度、评论数等信息

### 技术细节
- 使用 `/api/seasons/[id]/leaderboard?limit=10&type=score` API 获取前10名书籍（按得分排序）
- 懒加载：只有在点击展开按钮时才请求排行榜数据
- 数据缓存：已加载的排行榜数据不会重复请求

---

## v3.1 - 赛季管理权限分离

### 修改日期
2026-02-15

### 功能优化

#### 1. 管理员与普通用户权限分离
- **修改文件**:
  - `src/app/admin/page.tsx`: 移除非管理员重定向，传递 isAdmin 参数
  - `src/app/admin/admin-season-client.tsx`: 非管理员默认显示历史赛季 Tab
  - `src/components/layout/header.tsx`: 所有登录用户可见赛季管理入口

- **功能说明**:
  - 管理员(WhitePlusMS)可以看到完整的赛季管理功能
  - 普通用户看到"历史赛季"页面，直接显示历史赛季列表
  - 导航栏根据权限动态显示"赛季管理"或"历史赛季"

#### 2. ESLint 修复
- **修改文件**:
  - `src/components/comments/comment-list.tsx`: 添加 useCallback 依赖项 showError
