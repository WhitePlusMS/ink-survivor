// Prisma Schema - InkSurvivor 创作平台数据库设计
// 优化版本 V2：合并 1:1 关联表，删除无用表，提升查询性能

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 用户模块 (合并后) ====================
// 合并了 User, UserToken, UserLevel

model User {
  id              String    @id @default(cuid())
  secondMeId      String    @unique
  nickname        String
  avatar          String?
  email           String?
  isAdmin         Boolean   @default(false)

  // Agent 配置
  agentConfig     Json?
  readerConfig    Json?

  // Token 信息 (从 UserToken 合并)
  accessToken     String?
  refreshToken    String?
  tokenType       String    @default("Bearer")
  tokenExpiresAt      DateTime?
  tokenRefreshExpiresAt DateTime?
  tokenScope          String?
  tokenIsValid        Boolean   @default(true)
  tokenLastRefreshed  DateTime?
  tokenRefreshCount   Int       @default(0)

  // 等级信息 (从 UserLevel 合并)
  level           Int       @default(1)
  levelTitle      String    @default("新手作者")
  totalPoints     Int       @default(0)
  seasonPoints    Int       @default(0)
  booksWritten    Int       @default(0)
  booksCompleted  Int       @default(0)
  totalCoins      Int       @default(0)
  totalFavorites  Int       @default(0)
  unlockedFeatures Json     @default("[]")

  // 统计数据
  totalInk        Int       @default(0)
  seasonsJoined   Int       @default(0)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // 关联
  books           Book[]
  comments        Comment[]
  readings        Reading[]
}

// ==================== 赛季模块 ====================

model Season {
  id              String    @id @default(cuid())
  seasonNumber    Int       @unique
  status          String    @default("PENDING")  // PENDING, ACTIVE, FINISHED, CANCELLED

  themeKeyword    String
  constraints     Json
  zoneStyles      Json

  signupDeadline  DateTime
  startTime       DateTime
  endTime         DateTime

  duration        Json      @default("{\"reading\": 10, \"outline\": 5, \"writing\": 5}")
  maxChapters     Int       @default(10)
  minChapters     Int       @default(3)

  rewards         Json
  participantCount Int      @default(0)

  // 赛季轮次状态
  currentRound    Int       @default(0)
  roundPhase      String    @default("NONE") // NONE, READING, OUTLINE, WRITING
  roundStartTime  DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  books           Book[]

  @@index([status])
}

// 删除 SeasonParticipation - 字段与 Book 重复

// 删除 Leaderboard - 使用内存缓存

// 删除 SeasonQueue - 未使用

// 系统设置
model SystemSettings {
  id              String    @id @default(cuid())
  key             String    @unique
  value           Json
  description     String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ==================== 书籍模块 (合并后) ====================
// 合并了 Book, BookScore, Outline

model Book {
  id              String    @id @default(cuid())
  title           String
  coverImage      String?

  authorId        String
  author          User      @relation(fields: [authorId], references: [id])
  seasonId        String?
  season          Season?   @relation(fields: [seasonId], references: [id])

  zoneStyle       String
  shortDesc       String?
  longDesc        String?

  status          String    @default("DRAFT")
  currentChapter  Int       @default(0)
  plannedChapters Int?

  inkBalance      Int       @default(0)
  rank            Int?      // 赛季排名
  participationId String?

  // ===== 大纲信息 (从 Outline 合并) =====
  originalIntent  String?
  characters      Json?
  chaptersPlan    Json?
  modificationLog Json?

  // ===== 评分信息 (从 BookScore 合并) =====
  viewCount       Int       @default(0)
  favoriteCount   Int       @default(0)
  likeCount       Int       @default(0)
  coinCount       Int       @default(0)
  completionRate  Float     @default(0)

  avgSentiment    Float     @default(0)
  readerCount     Int       @default(0)
  avgRating       Float     @default(0)

  interactionScore Float    @default(0)
  sentimentScore  Float     @default(0)
  finalScore      Float     @default(0)
  heatValue       Float     @default(0)
  completenessBonus Float   @default(0)
  adaptabilityBonus Float    @default(0)
  adoptionRate     Float    @default(0)
  adoptedComments  Int      @default(0)

  scoreLastCalculated DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // 关联
  chapters           Chapter[]
  comments           Comment[]
  readings           Reading[]
  outlineVersions

  @@index BookOutlineVersion[]([authorId])
  @@index([seasonId])
  @@index([zoneStyle])
  @@index([status])
  @@index([createdAt])
  @@index([heatValue])
  @@index([finalScore])
  @@index([viewCount])
  @@index([likeCount])
}

// 大纲版本历史表
model BookOutlineVersion {
  id              String    @id @default(cuid())
  bookId          String
  book            Book      @relation(fields: [bookId], references: [id], onDelete: Cascade)

  version         Int       // 版本号：1, 2, 3...
  roundCreated    Int       // 创建时对应的轮次

  // 大纲内容（与 Book 表对应）
  originalIntent  String?   // 故事概要
  characters      Json?     // 人物列表
  chaptersPlan    Json?     // 章节大纲

  reason          String?   // 修改原因（初始版本为 null）

  createdAt       DateTime  @default(now())

  @@unique([bookId, version])
  @@index([bookId])
}

// 删除 Outline - 已合并到 Book
// 删除 BookScore - 已合并到 Book

// ==================== 章节模块 ====================

model Chapter {
  id              String    @id @default(cuid())
  bookId          String
  book            Book      @relation(fields: [bookId], references: [id], onDelete: Cascade)

  chapterNumber   Int
  title           String
  content         String    @default("")
  contentLength   Int       @default(0)

  status          String    @default("DRAFT")
  publishedAt     DateTime?

  chatSessionId   String?

  readCount       Int       @default(0)
  commentCount    Int       @default(0)
  likeCount       Int       @default(0)
  inkCost         Int       @default(10)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // 反向关系
  comments        Comment[]
  readings        Reading[]
  likes           Like[]

  @@unique([bookId, chapterNumber])
  @@index([bookId])
  @@index([status])
  @@index([publishedAt])
}

// ==================== 互动模块 ====================

model Comment {
  id              String    @id @default(cuid())
  bookId          String
  book            Book      @relation(fields: [bookId], references: [id])
  chapterId       String?
  chapter         Chapter?  @relation(fields: [chapterId], references: [id])
  userId          String?
  user            User?     @relation(fields: [userId], references: [id])

  isHuman         Boolean
  aiRole          String?

  content         String

  sentiment       Float?
  suggestionType  String?

  isAdopted       Boolean   @default(false)
  adoptedAt       DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([bookId])
  @@index([chapterId])
  @@index([userId])
  @@index([isAdopted])
}

model Reading {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  bookId          String
  book            Book      @relation(fields: [bookId], references: [id])
  chapterId       String
  chapter         Chapter   @relation(fields: [chapterId], references: [id])

  readAt          DateTime  @default(now())
  finished        Boolean   @default(false)
  readingTime     Int?

  createdAt       DateTime  @default(now())

  @@index([userId, bookId])
}

model Like {
  id              String    @id @default(cuid())
  userId          String
  chapterId       String
  chapter         Chapter   @relation(fields: [chapterId], references: [id])

  createdAt       DateTime  @default(now())

  @@unique([userId, chapterId])
  @@index([chapterId])
}

// 异步任务队列
model TaskQueue {
  id            String    @id @default(cuid())
  taskType      String    // 任务类型: OUTLINE, WRITE_CHAPTER, READER_AGENT, etc.
  payload       Json      // 任务参数
  status        String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  priority      Int       @default(0) // 优先级，数字越大越优先
  attempts      Int       @default(0) // 已尝试次数
  maxAttempts   Int       @default(3) // 最大尝试次数
  errorMessage String?   // 错误信息
  startedAt     DateTime? // 开始执行时间
  completedAt   DateTime? // 完成时间
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([status, priority])
  @@index([createdAt])
}
